<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Notes App</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      width: 500px;
      margin: 40px auto;
    }
    input, textarea {
      width: 100%;
      padding: 8px;
      margin-bottom: 8px;
      box-sizing: border-box;
    }
    button {
      padding: 6px 12px;
      cursor: pointer;
      margin-right: 6px;
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    ul {
      padding-left: 0;
      list-style: none;
    }
    li {
      background: #f9f9f9;
      padding: 10px;
      margin-bottom: 6px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-radius: 4px;
    }
    .note-content {
      flex: 1;
      margin-right: 10px;
    }
    .error { color: red; margin-top: 8px; }
    .success { color: green; margin-top: 8px; }

    /* Modal styles */
    #rateLimitModal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    #rateLimitModal div {
      background: #fff;
      padding: 20px 30px;
      border-radius: 8px;
      text-align: center;
      max-width: 300px;
    }
    #rateLimitModal h3 {
      margin-top: 0;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>

  <h2>Add Note</h2>
  <textarea id="note" placeholder="Write something"></textarea>
  <button id="addBtn" onclick="addNote()">Add</button>
  <p id="message"></p>

  <h2>Notes</h2>
  <ul id="list"></ul>

  <!-- Rate Limit Modal -->
  <div id="rateLimitModal">
    <div>
      <h3>Too Many Requests</h3>
      <p>Please wait a few seconds before trying again.</p>
      <button onclick="closeRateLimitModal()">OK</button>
    </div>
  </div>

<script>
const API = "http://localhost:8080";

function showMessage(text, type="error") {
  const el = document.getElementById("message");
  el.className = type;
  el.innerText = text;
}

async function safeJson(res) {
  try { return await res.json(); } catch { return {}; }
}

// Modal functions
function showRateLimitModal() {
  document.getElementById('rateLimitModal').style.display = 'flex';
}

function closeRateLimitModal() {
  document.getElementById('rateLimitModal').style.display = 'none';
}

// Handle rate-limit globally
function handleRateLimit(button, timeout = 10000) {
  if (button) button.disabled = true;
  showRateLimitModal();
  setTimeout(() => {
    if (button) button.disabled = false;
    closeRateLimitModal();
  }, timeout);
}

// Add a note
async function addNote() {
  const content = document.getElementById("note").value.trim();
  const button = document.getElementById("addBtn");

  if (!content) { showMessage("Note content cannot be empty"); return; }

  try {
    const res = await fetch("http://localhost:8080/createnotes", {
  method: "POST",
  headers: {"Content-Type": "application/json"},
  body: JSON.stringify({ content })
})

    const data = await safeJson(res);

    if (res.status === 429) {
      handleRateLimit(button);
      return;
    }

    if (!res.ok) { showMessage(data.error || "Something went wrong"); return; }

    showMessage("Note added successfully", "success");
    document.getElementById("note").value = "";
    loadNotes();

  } catch (err) { console.error(err); showMessage("Backend not reachable"); }
}

// Update a note
async function updateNote(_id, newContent, button) {
  if (!newContent.trim()) { showMessage("Note content cannot be empty"); return; }

  try {
    const res = await fetch(`${API}/updatenotes`, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({_id, content: newContent})
    });

    const data = await safeJson(res);

    if (res.status === 429) {
      handleRateLimit(button);
      return;
    }

    if (!res.ok) { showMessage(data.error || "Failed to update note"); return; }

    showMessage("Note updated successfully", "success");
    loadNotes();
  } catch (err) { console.error(err); showMessage("Backend not reachable"); }
}

// Delete a note
async function deleteNote(_id, button) {
  try {
    const res = await fetch(`${API}/deletenotes`, {
      method: "POST",
      headers: {"Content-Type": "application/json"},
      body: JSON.stringify({_id})
    });

    const data = await safeJson(res);

    if (res.status === 429) {
      handleRateLimit(button);
      return;
    }

    if (!res.ok) { showMessage(data.error || "Failed to delete note"); return; }

    showMessage("Note deleted successfully", "success");
    loadNotes();
  } catch (err) { console.error(err); showMessage("Backend not reachable"); }
}

// Load notes
async function loadNotes() {
  try {
    const res = await fetch(`${API}/notes`);
    const data = await safeJson(res);

    if (!res.ok) { showMessage(data.error || "Failed to load notes"); return; }

    const list = document.getElementById("list");
    list.innerHTML = "";

    data.forEach(n => {
      const li = document.createElement("li");

      const contentSpan = document.createElement("span");
      contentSpan.className = "note-content";
      contentSpan.innerText = n.content;

      const editInput = document.createElement("input");
      editInput.type = "text";
      editInput.value = n.content;
      editInput.style.display = "none";

      const editBtn = document.createElement("button");
      editBtn.innerText = "Edit";
      editBtn.onclick = () => {
        if (editInput.style.display === "none") {
          editInput.style.display = "inline";
          contentSpan.style.display = "none";
          editBtn.innerText = "Save";
        } else {
          updateNote(n._id, editInput.value, editBtn);
        }
      };

      const deleteBtn = document.createElement("button");
      deleteBtn.innerText = "Delete";
      deleteBtn.onclick = () => {
        if (confirm("Are you sure you want to delete this note?")) deleteNote(n._id, deleteBtn);
      };

      li.appendChild(contentSpan);
      li.appendChild(editInput);
      li.appendChild(editBtn);
      li.appendChild(deleteBtn);

      list.appendChild(li);
    });

  } catch (err) { console.error(err); showMessage("Unable to load notes"); }
}

loadNotes();
</script>

</body>
</html>
